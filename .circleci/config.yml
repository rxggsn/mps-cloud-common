# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/configuration-reference
version: 2.1
orbs:
  jq: circleci/jq@3.0.2
executors:
  build:
    docker:
      - image: cimg/rust:1.85.0
      - image: cimg/postgres:15.2
        environment:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: rxdomain
      - image: cimg/redis:6.2.12
      - image: bitnami/zookeeper:3.8
        environment:
          ALLOW_ANONYMOUS_LOGIN: yes
        command: >-
          --health-cmd "echo mntr | nc -w 2 -q 2 localhost 2181"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      - image: bitnami/kafka:2.8
        environment:
          KAFKA_CFG_LISTENERS: PLAINTEXT://:9092
          KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://127.0.0.1:9092
          KAFKA_CFG_ZOOKEEPER_CONNECT: localhost:2181
          ALLOW_PLAINTEXT_LISTENER: yes
          KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: true
        command: >-
          --health-cmd "kafka-topics.sh --list --bootstrap-server localhost:9092"
          --health-interval 10s
          --health-timeout 10s
          --health-retries 5
          --restart always
    resource_class: large

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/jobs-steps/#jobs-overview & https://circleci.com/docs/configuration-reference/#jobs
jobs:
  test:
    executor: build
    environment:
      ENV: "cicd"
    steps:
      - checkout
      - run:
          name: "Set up SSH and Git"
          command: |
            mkdir -p ~/.ssh
            ssh-keyscan github.com >> ~/.ssh/known_hosts
            echo $GIT_TOKEN
            git config --global --add url.https://x-access-token:$GIT_TOKEN@github.com/.insteadOf ssh://git@github.com/
            git config --global --add url.https://x-access-token:$GIT_TOKEN@github.com/.insteadOf git@github.com/
            git config --global --add url.https://x-access-token:$GIT_TOKEN@github.com/.insteadOf https://github.com/
            git config --global --add url.https://x-access-token:$GIT_TOKEN@github.com/.insteadOf git@github.com:
            git submodule sync
            git submodule update --init --recursive
      - run:
          name: "Install Dependencies"
          command: |
            sudo apt-get update 
            sudo apt install -y clang libpq5
      - run:
          name: "Test Mps Common"
          command: "chmod +x ./run_workflow.sh && ./run_workflow.sh"

# Orchestrate jobs using workflows
# See: https://circleci.com/docs/workflows/ & https://circleci.com/docs/configuration-reference/#workflows
workflows:
  build-and-test-workflow: # This is the name of the workflow, feel free to change it to better match your workflow.
    when:
      or:
        - equal: ["push", << pipeline.event.name >>] # This job will only run on the develop branch
        - and:
            - equal: ["pull_request", << pipeline.event.name >>] # This job will only run on the develop branch
            - equal: ["opened", << pipeline.event.action >>] # and only if the pull request is open
    # Inside the workflow, you define the jobs you want to run.
    jobs:
      - test:
          context: ggsn
